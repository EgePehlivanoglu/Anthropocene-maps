---
title: "Deforestation binary"
output: html_notebook
---
# Load Packages
```{r}
# install librarian package (working better than pacman)
# From CRAN:
install.packages("librarian")
librarian::shelf(httr, terra, tmap, tidyverse) # install and load packages
```

# 1. Load Data
```{r}
# 1) Download the public GeoTIFF (v1.2, 2001–2024) from Zenodo
url <- "https://zenodo.org/records/15366671/files/drivers_forest_loss_1km_2001_2024_v1_2.tif?download=1"  # Zenodo direct
tif_path <- tempfile(fileext = ".tif")
res <- GET(url, write_disk(tif_path, overwrite = TRUE))
stop_for_status(res)
```

# 2. Investigate data

```{r Arrange Data and Inspect}
# 2) Read the raster
# Band 1 = dominant class (uint8, 1..7); Bands 2..8 = class probabilities (0..250)
r_all <- rast(tif_path)
r <- r_all[[1]]          # dominant class only
r <- clamp(r, 1, 7,  values = FALSE)      # be safe: anything outside 1..7 to NA
# FALSE is added recently
# Investigate data
# r is your SpatRaster object. Here are some key properties to check:
r
# Resolution (pixel size in map units)
res(r)
# CRS / projection (WKT string)
crs(r)
# A friendlier summary: EPSG if recognized + proj string
terra::crs(r, describe=TRUE)
# Extent (bounding box) in CRS units
ext(r)
# Dimensions: nrows, ncols, nlyr
dim(r)
# Number of cells
ncell(r)
# convert data to categorical (factor) for plotting
r <- as.factor(r)        # categorical
```

# 3.1. Decrease resolution

```{r}
# 3) Reproject to Mollweide (categorical -> nearest neighbor)
r_moll <- project(r, "ESRI:54009", method = "near")
#define fact
fact <- round(5000 / res(r_moll)[1])
r_moll_5km <- aggregate(r_moll, fact = fact, fun = "modal", na.rm = TRUE)
res(r_moll_5km)
#r_moll_5km_cat <- aggregate(r_moll, fact = fact, fun = "modal")
#r_5km_cat <- aggregate(r, fact = fact, fun = "modal")
# Attach human-readable labels from the dataset docs (v1.2)
# Codes: 1 Perm. agriculture, 2 Hard commodities, 3 Shifting cultivation,
# 4 Logging, 5 Wildfire, 6 Settlements & infrastructure, 7 Other natural disturbances
lev <- data.frame(
  ID   = 1:7,
  name = c("Permanent agriculture",
           "Hard commodities",
           "Shifting cultivation",
           "Logging",
           "Wildfire",
           "Settlements & infrastructure",
           "Other natural disturbances"),
  binary_codes =c(1,1,1,0,0,0,0)
)
levels(r_moll_5km) <- list(lev)


# 4) Styling & plot (tmap)
# A readable, distinct palette (adjust if you want to match GFW’s exact colors)
pal <- c(
  "Permanent agriculture"          = "#E31A1C",
  "Hard commodities"               = "#A65628",
  "Shifting cultivation"           = "#FF7F00",
  "Logging"                        = "#1F78B4",
  "Wildfire"                       = "#6A3D9A",
  "Settlements & infrastructure"   = "#B2DF8A",
  "Other natural disturbances"     = "#BDBDBD"
)

tmap_mode("plot")
tm <- tm_shape(r_moll_5km) +
  tm_raster(col.style = tm_scale_categorical(pal),
            title = "Dominant drivers of tree cover loss (2001–2024)") +
  tm_layout(frame = FALSE, legend.outside = TRUE, legend.text.size = 0.9) +
  tm_grid(lines = TRUE, lwd = 0.2, alpha = 0.15)
tm
# Add layer
# install.packages(c("rnaturalearth", "rnaturalearthdata"))  # if needed
library(rnaturalearth)
library(sf)

# 1) Get land polygons and project to Mollweide
land <- ne_countries(scale = "medium", returnclass = "sf")
land_moll <- st_transform(land, "ESRI:54009")

# 2) Build the map: background first, then raster on top
tmap_mode("plot")
tm <- tm_shape(land_moll) +
  tm_polygons(col = "#E6EFF4", border.col = "#B8C9D3", lwd = 0.3) +  # oceans show through white bg; land tinted
  tm_shape(r_moll_5km) +
  tm_raster(style = "cat", palette = pal,
            title = "Dominant drivers of tree cover loss (2001–2024)") +
  tm_grid(lines = TRUE, lwd = 0.2, alpha = 0.15) +
  tm_layout(frame = FALSE, legend.outside = TRUE)
tm
```

# 3.2. Binary transformation for decreased resolution

```{r}
# metadata: -1 = non-ag land, -2 = water/no data  -> set to NA
r_moll_5km[r_moll_5km %in% c(-1, -2)] <- NA              # keep raw counts for everything else
names(r_moll_5km) <- "value"

# ---- target CRS: Mollweide ----
# Using a standard proj string for world Mollweide
crs_moll <- "+proj=moll +lon_0=0 +datum=WGS84 +units=m +no_defs"

# ---- reproject raster (use nearest neighbor to preserve raw counts) ----
r_moll <- project(r_moll_5km, crs_moll, method = "near")

# (Optional) speed up plotting if huge:
# r_moll <- aggregate(r_moll, fact = 2, fun = "first")

# ---- country boundaries -> sf -> Mollweide ----
world <- ne_countries(scale = "medium", returnclass = "sf")
world_moll <- st_transform(world, crs = crs_moll)

# ---- to data frame for ggplot ----
df <- as.data.frame(r_moll_5km, xy = TRUE, na.rm = TRUE)  # columns: x, y, value

df_bin <- df %>% 
  mutate(df_bin= case_when(value == "Permanent agriculture" ~ 1,
                           value == "Hard commodities" ~ 1,
                           value == "Shifting cultivation" ~ 1,
                           value == "Logging" ~ 0,
                           value == "Wildfire" ~ 0,
                           value == "Settlements & infrastructure" ~ 0,
                           value == "Other natural disturbances" ~ 0), factor(df_bin))

bin_plot_5km_res <- ggplot() +
  geom_tile(data = df_bin, aes(x = x, y = y, fill = factor(df_bin))) +
  geom_sf(data = world_moll, fill = NA, color = "black", linewidth = 0.2) +
  coord_sf() +
  scale_fill_manual(
    name = "Disturbance Types",
    values = c("0" = "#f4d03f",  # low risk (example yellow)
               "1" = "#c0392b",  # high risk (example red)
               "NA" = "white"),  # explicitly map NA to white
    na.value = "white",           # ensures NAs are white
    labels = c("0" = "Temporary", "1" = "Permanent")
  ) +
  labs(
    title = "Deforestation Plot",
    subtitle = "Binary Transformed Data",
    caption = "Permanent Disturbances:Permanent agriculture, Hard commodities, Shifting cultivation. Temporary Disturbances: Logging, Wildfire, Settlements & infrastructure, and Other natural disturbances",
    x = NULL, y = NULL
  ) +
  theme_minimal(base_size = 11) +
  theme(
    # panel.background = element_rect(fill = "gray85", color = NA), # gray background (ocean)
    # plot.background = element_rect(fill = "gray85", color = NA),
    panel.grid = element_blank(),
    legend.position = "right",
    legend.title = element_text(face = "bold"),
    legend.key.height = unit(0.6, "cm"),
    legend.text = element_text(size = 9)
  )
bin_plot_5km_res
```

# 4.1. High resolution

```{r}
# 3) Reproject to Mollweide (categorical -> nearest neighbor)
#r_moll <- project(r, "ESRI:54009", method = "near")
#use new projection since many points failed to transform (specify the resolution)
moll <- "+proj=moll +lon_0=0 +datum=WGS84 +units=m +no_defs"
r_moll <- terra::project(r, moll, method="near", res=10000)

#r_moll_5km_cat <- aggregate(r_moll, fact = fact, fun = "modal")
#r_5km_cat <- aggregate(r, fact = fact, fun = "modal")
# Attach human-readable labels from the dataset docs (v1.2)
# Codes: 1 Perm. agriculture, 2 Hard commodities, 3 Shifting cultivation,
# 4 Logging, 5 Wildfire, 6 Settlements & infrastructure, 7 Other natural disturbances
# lev <- data.frame(
#   ID   = 1:7,
#   name = c("Permanent agriculture",
#            "Hard commodities",
#            "Shifting cultivation",
#            "Logging",
#            "Wildfire",
#            "Settlements & infrastructure",
#            "Other natural disturbances"),
#   binary_codes =c(1,1,1,0,0,0,0)
# )
# levels(r_moll[[1]]) <- list(lev)


# 4) Styling & plot (tmap)
# A readable, distinct palette (adjust if you want to match GFW’s exact colors)
pal <- c(
  "Permanent agriculture"          = "#E31A1C",
  "Hard commodities"               = "#A65628",
  "Shifting cultivation"           = "#FF7F00",
  "Logging"                        = "#1F78B4",
  "Wildfire"                       = "#6A3D9A",
  "Settlements & infrastructure"   = "#B2DF8A",
  "Other natural disturbances"     = "#BDBDBD"
)


# 1) Get land polygons and project to Mollweide
land <- ne_countries(scale = "medium", returnclass = "sf")
land_moll <- st_transform(land, "ESRI:54009")

# 2) Build the map: background first, then raster on top
tmap_mode("plot")
tm <- tm_shape(land_moll) +
  tm_polygons(col = "#E6EFF4", border.col = "#B8C9D3", lwd = 0.3) +  # oceans show through white bg; land tinted
  tm_shape(r_moll) +
  tm_raster(style = "cat", palette = pal,
            title = "Dominant drivers of tree cover loss (2001–2024)") +
  tm_grid(lines = TRUE, lwd = 0.2, alpha = 0.15) +
  tm_layout(frame = FALSE, legend.outside = TRUE)
tm
```

# 4.2. Binary transformation for high resolution

```{r}
# metadata: -1 = non-ag land, -2 = water/no data  -> set to NA
r_moll[r_moll %in% c(-1, -2)] <- NA              # keep raw counts for everything else
names(r_moll) <- "value"

# ---- target CRS: Mollweide ----
# Using a standard proj string for world Mollweide
crs_moll <- "+proj=moll +lon_0=0 +datum=WGS84 +units=m +no_defs"

# ---- reproject raster (use nearest neighbor to preserve raw counts) ----
r_moll <- project(r_moll, crs_moll, method = "near")

# (Optional) speed up plotting if huge:
# r_moll <- aggregate(r_moll, fact = 2, fun = "first")

# ---- country boundaries -> sf -> Mollweide ----
world <- ne_countries(scale = "medium", returnclass = "sf")
world_moll <- st_transform(world, crs = crs_moll)
gc() #important so the memory limit is OK
# ---- to data frame for ggplot ----
df <- as.data.frame(r_moll, xy = TRUE, na.rm = TRUE)  # columns: x, y, value

df_hr_bin <- df %>% 
  mutate(df_bin= case_when(value == "Permanent agriculture" ~ 1,
                           value == "Hard commodities" ~ 1,
                           value == "Shifting cultivation" ~ 1,
                           value == "Logging" ~ 0,
                           value == "Wildfire" ~ 0,
                           value == "Settlements & infrastructure" ~ 0,
                           value == "Other natural disturbances" ~ 0), factor(df_bin))

bin_plot_hr <- ggplot() +
  geom_tile(data = df_hr_bin, aes(x = x, y = y, fill = factor(df_bin))) +
  geom_sf(data = world_moll, fill = NA, color = "black", linewidth = 0.2) +
  coord_sf() +
  scale_fill_manual(
    name = "Disturbance Types",
    values = c("0" = "#f4d03f",  # low risk (example yellow)
               "1" = "#c0392b",  # high risk (example red)
               "NA" = "white"),  # explicitly map NA to white
    na.value = "white",           # ensures NAs are white
    labels = c("0" = "Temporary", "1" = "Permanent")
  ) +
  labs(
    title = "Deforestation Plot",
    subtitle = "Binary Transformed Data",
    caption = "Permanent Disturbances:Permanent agriculture, Hard commodities, Shifting cultivation. Temporary Disturbances: Logging, Wildfire, Settlements & infrastructure, and Other natural disturbances",
    x = NULL, y = NULL
  ) +
  theme_minimal(base_size = 11) +
  theme(
    # panel.background = element_rect(fill = "gray85", color = NA), # gray background (ocean)
    # plot.background = element_rect(fill = "gray85", color = NA),
    panel.grid = element_blank(),
    legend.position = "right",
    legend.title = element_text(face = "bold"),
    legend.key.height = unit(0.6, "cm"),
    legend.text = element_text(size = 9)
  )
bin_plot_hr
```


